name: JUP Trading Bot

on:
  # Automatic schedule: every 5 minutes
  schedule:
    - cron: '*/15 * * * *'
  
  # MANUAL TRIGGER: Allows you to run from GitHub UI
  workflow_dispatch:
    inputs:
      log_level:
        description: 'Log level'
        required: true
        default: 'info'
        type: choice
        options:
        - info
        - debug
      tags:
        description: 'Test scenario tags'
        required: false
        type: boolean
      environment:
        description: 'Environment to run in'
        type: environment
        required: false
  
  # Trigger on code push (optional)
  push:
    branches: [ main ]

jobs:
  run-bot:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install ALL required packages
      run: |
        pip install ccxt pandas ta requests
    
    - name: Run JUP Bot
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      run: |
        python -c "
import os
import pandas as pd
import requests
import ccxt
from ta.momentum import RSIIndicator, StochasticOscillator
import datetime

print('üéØ JUP Bot Started')
print('=' * 50)

try:
    # Get webhook from environment
    webhook = os.environ.get('DISCORD_WEBHOOK')
    
    # Initialize OKX exchange
    exchange = ccxt.okx({
        'options': {
            'defaultType': 'swap'  # For perpetual futures
        }
    })
    
    # Fetch JUP data
    data = exchange.fetch_ohlcv('JUP/USDT:USDT', '15m', limit=100)
    
    # Create DataFrame
    df = pd.DataFrame(data, columns=['timestamp', 'open', 'high', 'low', 'close', 'volume'])
    df['close'] = pd.to_numeric(df['close'])
    df['high'] = pd.to_numeric(df['high'])
    df['low'] = pd.to_numeric(df['low'])
    
    # Calculate RSI
    df['rsi'] = RSIIndicator(df['close'], window=14).rsi()
    
    # Calculate Stochastic RSI
    stoch = StochasticOscillator(
        high=df['high'],
        low=df['low'],
        close=df['close'],
        window=14,
        smooth_window=3
    )
    df['stoch_k'] = stoch.stoch()
    
    # Get current values
    price = df['close'].iloc[-1]
    rsi = df['rsi'].iloc[-1]
    stoch_k = df['stoch_k'].iloc[-1]
    
    print(f'‚è∞ Time: {datetime.datetime.now().strftime(\"%H:%M:%S\")}')
    print(f'üí∞ Price: ${price:.4f}')
    print(f'üìâ RSI: {rsi:.2f}')
    print(f'üìä Stochastic: {stoch_k:.2f}')
    
    # Check alerts
    if rsi < 30 and stoch_k < 20:
        message = f'üö® JUP OVERSOLD!\nPrice: ${price:.4f}\nRSI: {rsi:.2f}\nStochastic: {stoch_k:.2f}'
        if webhook:
            requests.post(webhook, json={'content': message})
            print('‚úÖ OVERSOLD alert sent to Discord')
        else:
            print('‚ùå No Discord webhook configured')
    elif rsi > 70 and stoch_k > 80:
        message = f'üö® JUP OVERBOUGHT!\nPrice: ${price:.4f}\nRSI: {rsi:.2f}\nStochastic: {stoch_k:.2f}'
        if webhook:
            requests.post(webhook, json={'content': message})
            print('‚úÖ OVERBOUGHT alert sent to Discord')
        else:
            print('‚ùå No Discord webhook configured')
    else:
        print('‚úÖ No alerts triggered')
    
    print('=' * 50)
    print('‚úÖ Bot execution completed successfully')
    
except Exception as e:
    print(f'‚ùå Error occurred: {e}')
    print('=' * 50)
    print('‚ùå Bot failed')
"
